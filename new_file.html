<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>去缴费</title>
    <link rel="stylesheet" type="text/css" href="./css/index.css" />
	<script type="text/javascript" src="./js/jquery-1.11.3.js"></script>
	<script src="js/laypage/laypage.js"></script>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	<script src="js/conf.js"></script>
    <style>
        html {
            background-image: url('./images/detailsbg.png');
            background-repeat: no-repeat;
            background-size: 100%;
        }
    </style>
</head>

<body>
	<div class="goPayBox">
		<div class="goPayContent">
			<div class="gp_Title">我的停车信息</div>
			<div class="details_PayBox">
				<div class="details_PayDiv">
					<table class="details_PayTab">
					</table>
					<div class="noDetails_BOX">
						<img src="./images/no_message.png"/>
						<p> 车辆进入停车场后,可在这里查看相关信息</p>
					</div>
				</div>
			</div>
			<div class="HistoryOwe">
				<div class="HistoryTitle">
					您有未缴订单
				</div>
				<table class="goPHis_Tab">
					<tbody id="infolist">
					</tbody>
				</table>
				<div id="biuuu_city"></div>
			</div>
			<div class="detailsModul">
				<div class="detailsModulDiv">
					<div class="detailclose">X</div>
					<div class="theDivider"></div>
					<div id="details_order">
						
					</div>
					
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	 //将毫秒转换为时分秒
	formatSeconds = (value) => {
		var theTime = parseInt(value,10);// 秒
		var theTime1 = 0;// 分
		var theTime2 = 0;// 小时
		if(theTime > 60) {
			theTime1 = parseInt(theTime/60,10);
			theTime = parseInt(theTime%60,10);
				if(theTime1 > 60) {
				theTime2 = parseInt(theTime1/60,10);
				theTime1 = parseInt(theTime1%60,10);
				}
		}
			var result = ""+parseInt(theTime,10)+"秒";
			if(theTime1 > 0) {
			result = ""+parseInt(theTime1,10)+"分"+result;
			}
			if(theTime2 > 0) {
			result = ""+parseInt(theTime2,10)+"小时"+result;
			}
		return result;
	}
	function wxpay(e){
		//当前订单号 发起微信支付
		var orderNo=$(e).attr("data-value");
		//var openid=sessionStorage.getItem("openid");
		//ooijkwsynsuF9fuU9MgEssH7HPCI
		var openid=sessionStorage.getItem("openid");
		var jsondata='{"orderNo":"'+orderNo+'","cancel_url":"http://wx.parking.bokentech.cn/orderForm.html","success_url":"http://wx.parking.bokentech.cn/orderForm.html","result_url":"http://wx.parking.bokentech.cn/orderForm.html","channel": "wx_pub","open_id":"'+openid+'"}';
		$.ajax({
			contentType: "application/json; charset=utf-8", 
			url: 'http://106.75.86.93:8070/parking/api/wx/order/v_1/getPaySign', //接口地址
			data:jsondata,
			type:'POST',
			dataType: "json",
			success:function(res){
				console.log(res);
				var param=res.result;
				wx.config({
                        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: param.appId, // 必填，公众号的唯一标识
                        timestamp: param.timeStamp, // 必填，生成签名的时间戳
                        nonceStr: param.nonceStr, // 必填，生成签名的随机串
                        signature: param.sign,// 必填，调用js签名，
                        jsApiList: ['chooseWXPay'] // 必填，需要使用的JS接口列表，这里只写支付的
                    });
                    wx.chooseWXPay({
                        timestamp: param.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                        nonceStr: param.nonceStr, // 支付签名随机串，不长于 32 位
                        package: param.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                        signType: "MD5", // 签名方式，默认为´SHA1´，使用新版支付需传入´MD5´
                        paySign: param.sign, // 支付签名
                        success: function (res) {
                            if(res.errMsg == "chooseWXPay:ok"){
                                alert("支付成功");
								window.location.href='./myCarList.html'
                            }else{
                                alert(res.errMsg);
                            }
                        },
                        cancel: function(res){
                            alert('取消支付');
                        }
                    });
			},error:function(res){
				//支付失败
				alert('支付失败');
			}
		})	
	}
	var url=location.href;
	var arr=url.split("?");
	var numberid=decodeURI(decodeURI(arr[1]));
	console.log(numberid);
	console.table(arr);
	$.ajax({
		type:'GET',
		url:'http://106.75.86.93:8070/parking/api/wx/order/v_1/list',
		data:{
			'numberPlate':numberid,
			'type':'qf',
			'currentPage':1,
			'limit':1
			
		},
		success:function(res){
			//console.log(res);
			var data = res.result.content;
			console.log(data.length);
			if(data.length>0){
				if(data[0].timingEnd==null){
					var html = '';
					var pay_moneyBotton = ''
					for(var i = 0;i<data.length;i++){
						var time = formatSeconds(data[i].stopTime);
						// 预交金额
						var prequelMoney = data[i].prequelMoney /100;
						// 预计收费
						var expectedMoney = data[i].expectedMoney/100;
						//console.log(prequelMoney,expectedMoney)
						//应缴金额
						var assessmentMoney = expectedMoney - prequelMoney
						if(data[i].payStatus=="PRE_PAY"){
							//预支付金额 小于应缴金额 支付不足金额
							if(assessmentMoney>0){
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" onclick="wxpay(this)"> 确认支付</button>';
							}else if(assessmentMoney==0){
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" disabled="disabled""> 预支付</button>';
							}else if(assessmentMoney<0){
								assessmentMoney='<span class="Aprofile">剩余 </span>'+Math.abs(assessmentMoney)
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" disabled="disabled""> 预支付</button>';
							}
						} else if(data[i].payStatus=="NOT_PAY"){
							//预支付金额 小于应缴金额 支付不足金额
							if(assessmentMoney>0){
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" onclick="wxpay(this)"> 确认支付</button>';
							}else if(assessmentMoney==0){
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" disabled="disabled""> 免费停车中...</button>';
							}else if(assessmentMoney<0){
								assessmentMoney='<span class="Aprofile">剩余 </span>'+Math.abs(assessmentMoney)
								pay_moneyBotton='<button data-value="'+data[i].orderNo+'" disabled="disabled""> 免费停车中...</button>';
							}
						}
						html += '<tr class="details_PayTr">' +
									'<td colspan="2">'+assessmentMoney+'<strong class="Aprofile"> 元</strong></td>'+
								'</tr>'+
								'<tr>'+
									' <td>订 单 号</td>'+
									' <td>'+data[i].orderNo+'</td>'+
								'</tr>'+
								'<tr>'+
									'<td>车牌号码</td>'+
									'<td>'+data[i].numberPlate+'</td>'+
								'</tr>'+
								'<tr>'+
									'<td>联系方式</td>'+
									'<td>'+data[i].personPhone+'</td>'+
								'</tr>'+
								'<tr>'+
									'<td>开始时间</td>'+
									'<td>'+data[i].startTime +'</td>'+
								'</tr>'+
								'<tr>'+
									' <td>停车时长</td>'+
									' <td>'+time+'</td>'+
								'</tr>'+
								'<tr>'+
									'<td>总金额</td>'+
									'<td>'+expectedMoney+'/元</td>'+
								'</tr>'+
								'<tr>'+
									'<td>预支付</td>'+
									'<td>'+ prequelMoney+'/元</td>'+
								'</tr>'+
								'<tr>'+
									'<td>应缴金额</td>'+
									'<td>'+assessmentMoney+'/元</td>'+
								'</tr>'+
								'<tr class="detailsPay_But">'+
									'<td colspan="2">'+pay_moneyBotton+'</td>'+
								'</tr>';
								
						//pay_moneyBotton += ''	
					}
					$(".details_PayTab").html(html)
				}else if(data[0].timingEnd != null){
					$(".noDetails_BOX").show()
				
				}
			}else if(data.length<=0){
				$(".noDetails_BOX").show()
			}
			
		},error:function(){
			alert("服务器内部错误");
		}
	
	})
	$(function(){
		tes();
		$('.detailclose').click(function() {
			$('.detailsModul').fadeOut(500)
		})
	})
	//开始是一样的分页
		function tes(){
			$("#infolist,#infolist1").empty();
			$.ajax({
				type: 'GET', //POST	提交方式
				url: 'http://106.75.86.93:8070/parking/api/wx/order/v_1/list', //接口地址
				data: {
					//请求中附加的参数
					numberPlate: numberid,
					type: 'qf',
					currentPage: 1,
					limit: 5
				},
				success:function(data){
					//$("#biuuu_city").empty();
					//$("#biuuu_city1").empty();
					console.log(data)
					var nums=data.result.size;
					var pages=data.result.totalPages;
					var thisDate = function(curr){
						var str = '', last = curr*nums - 1;
						last = last >= data.result.content.length ? (data.result.content.length-1) : last;
						for(var i = (curr*nums - nums); i <= last; i++){
							str += '<li>'+ data.result.content[i] +'</li>';
						}
						console.log(str)
						return str;
					};
					//调用分页
					laypage({
						cont: 'biuuu_city',		//分页容器id
						pages: pages,
						jump: function(obj){
							loadajax(obj.curr,numberid,'qf')   // obj.curr:1
						}
					})
				}

			});

			//当前页码和车牌号
			function loadajax(pageNumber,o,p){
				//var numberPlate = $("#plateNumberSelect option:selected").val();
				$.ajax({
					type: 'GET', //POST	提交方式
					url: 'http://106.75.86.93:8070/parking/api/wx/order/v_1/list', //接口地址
					data: {
						//请求中附加的参数
						numberPlate: o,
						type: p,
						currentPage: pageNumber,
						limit: 5,
					},
					success: function(res) {
						//通讯成功后回调
						//console.log(res.result.content);
						var orderinfosplice=res.result.content.splice(0,1);
						var orderinfo = res.result.content
						if(orderinfo.length<1){
							$(".HistoryOwe").hide();
						}else if(orderinfo.length>=1){
							var html='';
							var pagehtml='';
							for(var i=0;i<orderinfo.length;i++){
								var time = formatSeconds(orderinfo[i].stopTime);
								html+=' <tr>'+
										'<td>'+orderinfo[i].orderNo+'</td>'+
										'<td>'+orderinfo[i].numberPlate+'</td>'+
										//'<td>'+time+'</td>'+
										//'<td>'+orderinfo[i].expectedMoney/100 +'</td>'+
										'<td><button class="OrderAndSettlement" uid="'+orderinfo[i].orderNo+'" onclick="detail(this)">支付</button></td>'+
									'</tr>';
							}
							$("#infolist").html(html);
						}
					},
					error: function(xhr, dataType, errorThrown) {
						//错误处理
						alert("服务器内部错误");
					}

				});
			}
		}
	//查看订单详情
	function detail(d){
		var uid=$(d).attr("uid");
		//console.log("order："+uid);
		//location.href='订单也.html?'+uid;
		$(".detailsModul").show();
		$.ajax({
			url: 'http://106.75.86.93:8070/parking/api/wx/order/v_1/orderInfo', //接口地址
            data: {
              orderNo: uid,
            },
			type:'GET',
			success:function(res){
				console.log(res);
				var data = res.result;
				// 预交金额
				var prequelMoney = data.prequelMoney /100;
				// 预计收费
				var expectedMoney = data.expectedMoney/100;
				//console.log(prequelMoney,expectedMoney)
				//应缴金额
				var assessmentMoney = expectedMoney - prequelMoney
				var payStatus ="";
				var btn_pay='';
				if(data.payStatus=="NOT_PAY"){
					payStatus="未支付";
					if(assessmentMoney===0){
						btn_pay='<div class="detaildiv">'+
							'<button class="detailsButton bgcolor79" disabled="disabled" >免费停车中...</button>'+
						'</div>';
					}else if(assessmentMoney>0){
						btn_pay='<div class="detaildiv">'+
							'<button class="detailsButton" data-value="'+data.orderNo+'" onclick="wxpay(this)">支付</button>'+
						'</div>';
					}else if(assessmentMoney<0){
						assessmentMoney='<span class="Aprofile">剩余 </span>'+Math.abs(assessmentMoney)
						btn_pay='<div class="detaildiv">'+
							'<button class="detailsButton bgcolor79" disabled="disabled">免费停车中...</button>'+
						'</div>';
					}
					
				}else if(data.payStatus=="PRE_PAY"){
					payStatus="预支付";
					//预支付金额 小于应缴金额 支付不足金额
					var money=data.expectedMoney-data.prequelMoney;
					if(money>0){
						btn_pay='<div class="detaildiv">'+
						'<button class="detailsButton bgcolor79" data-value="'+data.orderNo+'">请使用现金支付</button>'+
						'</div>';
					}else if(money==0){
						btn_pay='<div class="detaildiv">'+
							'<button class="detailsButton bgcolor79" disabled="disabled" >请使用现金支付</button>'+
						'</div>';
					}else if(money<0){
						
						assessmentMoney='<span class="Aprofile">剩余 </span>'+Math.abs(assessmentMoney)
						btn_pay='<div class="detaildiv">'+
							'<button class="detailsButton bgcolor79" disabled="disabled" >请寻找管理员退还现金</button>'+
						'</div>';
					}
				}else{
					payStatus="未知";
				}
				var time = formatSeconds(data.stopTime);
				var timingEnd =  data.timingEnd 
				if(timingEnd===null){
					timingEnd = '计算中...'
				}
				
				var orderdetails_html='<div class="detailsTtile">'+
                '<span>铂肯智能停车场</span>'+
                '<br/>'+
                '<span class="dtMoney">'+assessmentMoney +'<strong class="Aprofile"> 元</strong></span>'+
            '</div>'+
            '<table class="detailsTable">'+
                '<tbody>'+
                    '<tr>'+
                       ' <td>订单号: </td>'+
                       ' <td>'+data.orderNo+'</td>'+
                       ' <td>停车时长: </td>'+
                       ' <td>'+time+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>车牌号码: </td>'+
                        '<td>'+data.numberPlate+'</td>'+
                        '<td>联系方式: </td>'+
                       ' <td>'+data.personPhone+'</td>'+
                   ' </tr>'+
                    '<tr>'+
                        '<td>开始时间: </td>'+
                        '<td>'+data.startTime +'</td>'+
                        '<td>结束时间: </td>'+
                        '<td>'+timingEnd +'</td>'+
                    '</tr>'+
                    '<tr>'+
						'<td>支付状态: </td>'+
                        '<td>'+payStatus+'</td>'+
                        '<td>预支付: </td>'+
                        '<td>'+ prequelMoney+'/元</td>'+
                    '</tr>'+
					'<tr>'+
						'<td>总金额: </td>'+
                        '<td>'+expectedMoney+'/元</td>'+
                        '<td>应缴金额: </td>'+
                        '<td>'+assessmentMoney+'/元</td>'+
                    '</tr>'+
               ' </tbody>'+
            '</table>';
           var html=orderdetails_html+btn_pay;
				$("#details_order").html(html);
			},error:function(a,b,c){
				console.log(b);
			}
		
		})
	}
	
</script>
</body>

</html>